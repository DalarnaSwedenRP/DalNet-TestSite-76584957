<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WindCode 2D Prototype</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        #codeWindow {
            width: 50%;
            height: 100%;
            padding: 10px;
            box-sizing: border-box;
            background-color: #f0f0f0;
        }
        #codeInput {
            width: 100%;
            height: 80%;
            font-family: monospace;
            font-size: 14px;
            padding: 10px;
            resize: none;
            border: 1px solid #ccc;
        }
        #runButton {
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        #canvasWindow {
            width: 50%;
            height: 100%;
            background-color: #000;
        }
        canvas {
            display: block;
        }
    </style>
</head>
<body>
    <div id="codeWindow">
        <textarea id="codeInput" placeholder="Skriv din WindCode här, t.ex.:\nlocal\nplace('block', 50, 50, 0, 100, 100, 0)\ncolor: red;\nend\nlocal\nplace('sphere', 200, 200, 0, 50, 50, 0)\ncolor: blue;\nend\nlocal\ntext('Hello World', 150, 150, 0, 250, 50, 0)\ncolor: green;\nend\nlocal\nimage(20, 20, 0, 100, 100, 0)\nurl: https://example.com/image.jpg;\ntransparency: 0.5;\nend"></textarea>
        <button id="runButton">Kör kod</button>
    </div>
    <div id="canvasWindow">
        <canvas id="renderCanvas"></canvas>
    </div>

    <script>
        const canvas = document.getElementById('renderCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth / 2;
        canvas.height = window.innerHeight;

        // Funktion för att tolka och köra WindCode
        function runWindCode(code) {
            // Rensa canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const lines = code.split('\n').map(line => line.trim()).filter(line => line);
            let currentObject = null;
            let currentColor = 'white';
            let currentUrl = null;
            let currentTransparency = 1;
            let expectingLocal = true;
            let expectingColor = false;
            let expectingUrl = false;
            let expectingTransparency = false;
            let expectingEnd = false;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                if (expectingLocal && line === 'local') {
                    expectingLocal = false;
                    continue;
                }

                if (!expectingLocal && line.startsWith('place(')) {
                    const params = line.match(/place\("([^"]+)",\s*(\d+),\s*(\d+),\s*(\d+),\s*(\d+),\s*(\d+),\s*(\d+)\)/);
                    if (params) {
                        const [, type, x, y, , width, height] = params;
                        currentObject = { type, x: parseInt(x), y: parseInt(y), width: parseInt(width), height: parseInt(height) };
                        expectingColor = true;
                        continue;
                    }
                }

                if (!expectingLocal && line.startsWith('text(')) {
                    const params = line.match(/text\("([^"]+)",\s*(\d+),\s*(\d+),\s*(\d+),\s*(\d+),\s*(\d+),\s*(\d+)\)/);
                    if (params) {
                        const [, text, x, y, , width, height] = params;
                        currentObject = { type: 'text', text, x: parseInt(x), y: parseInt(y), width: parseInt(width), height: parseInt(height) };
                        expectingColor = true;
                        continue;
                    }
                }

                if (!expectingLocal && line.startsWith('image(')) {
                    const params = line.match(/image\((\d+),\s*(\d+),\s*(\d+),\s*(\d+),\s*(\d+),\s*(\d+)\)/);
                    if (params) {
                        const [, x, y, , width, height] = params;
                        currentObject = { type: 'image', x: parseInt(x), y: parseInt(y), width: parseInt(width), height: parseInt(height) };
                        expectingUrl = true;
                        continue;
                    }
                }

                if (expectingColor && line.startsWith('color:')) {
                    const colorMatch = line.match(/color:\s*(\w+);/);
                    if (colorMatch) {
                        currentColor = colorMatch[1];
                        expectingColor = false;
                        expectingEnd = true;

                        // Rita objektet (block, sphere, text)
                        ctx.fillStyle = currentColor;
                        if (currentObject.type === 'block') {
                            ctx.fillRect(currentObject.x, currentObject.y, currentObject.width, currentObject.height);
                        } else if (currentObject.type === 'sphere') {
                            ctx.beginPath();
                            ctx.arc(currentObject.x + currentObject.width / 2, currentObject.y + currentObject.height / 2, currentObject.width / 2, 0, 2 * Math.PI);
                            ctx.fill();
                        } else if (currentObject.type === 'text') {
                            ctx.font = `${currentObject.height}px Arial`;
                            ctx.fillText(currentObject.text, currentObject.x, currentObject.y + currentObject.height);
                        }
                        continue;
                    }
                }

                if (expectingUrl && line.startsWith('url:')) {
                    const urlMatch = line.match(/url:\s*([^;]+);/);
                    if (urlMatch) {
                        currentUrl = urlMatch[1];
                        expectingUrl = false;
                        expectingTransparency = true;
                        continue;
                    }
                }

                if (expectingTransparency && line.startsWith('transparency:')) {
                    const transparencyMatch = line.match(/transparency:\s*(0|0\.[1-9]|1);/);
                    if (transparencyMatch) {
                        currentTransparency = parseFloat(transparencyMatch[1]);
                        expectingTransparency = false;
                        expectingEnd = true;

                        // Rita bilden
                        if (currentObject.type === 'image' && currentUrl) {
                            const img = new Image();
                            img.crossOrigin = 'Anonymous';
                            img.onload = () => {
                                ctx.globalAlpha = currentTransparency;
                                ctx.drawImage(img, currentObject.x, currentObject.y, currentObject.width, currentObject.height);
                                ctx.globalAlpha = 1; // Återställ transparens
                            };
                            img.onerror = () => {
                                ctx.clearRect(0, 0, canvas.width, canvas.height);
                                ctx.fillStyle = 'red';
                                ctx.font = '20px Arial';
                                ctx.fillText('Failed to load image at line: ' + (i + 1), 10, 50);
                            };
                            img.src = currentUrl;
                        }
                        continue;
                    }
                }

                if (expectingEnd && line === 'end') {
                    expectingEnd = false;
                    expectingLocal = true;
                    currentObject = null;
                    currentColor = 'white';
                    currentUrl = null;
                    currentTransparency = 1;
                    continue;
                }

                // Om syntaxen är felaktig, rensa canvas och visa fel
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'red';
                ctx.font = '20px Arial';
                ctx.fillText('Syntax error at line: ' + (i + 1), 10, 50);
                return;
            }
        }

        // Hantera kör-knappen
        document.getElementById('runButton').addEventListener('click', () => {
            const code = document.getElementById('codeInput').value;
            runWindCode(code);
        });
    </script>
</body>
</html>
